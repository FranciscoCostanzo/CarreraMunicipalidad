<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ranking de Corredores</title>
    <link rel="stylesheet" href="./style/style.css" />
  </head>

  <body>
    <header>
      <h3>V.1.0.0</h3>
      <a href="./index.html" class="btn__volver">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path d="M13 14l-4 -4l4 -4" />
              <path d="M8 14l-4 -4l4 -4" />
              <path d="M9 10h7a4 4 0 1 1 0 8h-1" />
          </svg>
          Volver
      </a>
  </header>
    <h1>Ranking de Corredores</h1>

    <!-- Formulario para filtrar corredores -->
    <form id="rankingForm">
      <label for="sexo"></label>
      <select id="sexo" name="sexo">
        <option value="F">Femenino</option>
        <option value="M">Masculino</option>
      </select>

      <label for="categoria"></label>
      <select id="categoria" name="categoria">
        <option value="">Ninguna</option>
      </select>
      
      <label for="categoriaG"></label>
      <select id="categoriaG" name="categoriaG">
        <option value="">Ninguna</option>
        <option value="1">5 km General</option>
        <option value="2">10 km General</option>
        <option value="3">21 km General</option>
      </select>

      <button class="ranking__button" type="submit">Filtrar</button>
    </form>

    <!-- Tabla donde se mostrarán los datos de corredores -->
    <section class="contenedor__ranking">
      <h1>Datos de Corredores</h1>
      <table id="corredoresTable">
        <thead>
          <tr id="tableHeader"></tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      // Función para obtener las categorías desde PHP
      async function obtenerCategorias() {
        try {
          const response = await fetch("https://ambuvirtual.com/pedirCategorias.php");
          const data = await response.json();
          const categoriaSelect = document.getElementById("categoria");

          categoriaSelect.innerHTML = '<option value="">Ninguna</option>';
          data.forEach((categoria) => {
            const option = document.createElement("option");
            option.value = categoria.id;
            option.textContent = `${categoria.distancia_km} km - ${categoria.rango}`;
            categoriaSelect.appendChild(option);
          });
        } catch (error) {
          console.error("Error al obtener las categorías:", error);
        }
      }

      // Función para enviar los datos del formulario y obtener los corredores
      async function enviarFormulario(event) {
        event.preventDefault();

        const form = document.getElementById("rankingForm");
        const formData = new FormData(form);

        try {
          const response = await fetch("https://ambuvirtual.com/ranking.php", {
            method: "POST",
            mode: "cors",
            body: formData,
          });

          // Verifica la respuesta como texto antes de intentar parsear JSON
          const textResponse = await response.text();

          // Si la respuesta no es JSON, muestra el texto para depuración
          try {
            const result = JSON.parse(textResponse);

            if (result.error) {
              console.error("Error en el servidor:", result.error);
              Swal.fire({
                title: "Error",
                text: result.error,
                icon: "error",
              });
            } else {
              console.log("Datos recibidos del servidor:", result);
              mostrarTabla(result);
            }
          } catch (jsonError) {
            console.error("Error al parsear JSON:", textResponse);
            Swal.fire({
              title: "Error",
              text: "Error al parsear la respuesta del servidor.",
              icon: "error",
            });
          }
        } catch (error) {
          console.error("Error al enviar los datos:", error);
          Swal.fire({
            title: "Error",
            text: error.message,
            icon: "error",
          });
        }
      }

      // Función para mostrar los datos en la tabla
      function mostrarTabla(data) {
        const tableHeader = document.getElementById("tableHeader");
        const tableBody = document.getElementById("tableBody");

        tableHeader.innerHTML = "";
        tableBody.innerHTML = "";

        if (Array.isArray(data) && data.length > 0) {
          const headers = Object.keys(data[0]);
          headers.forEach((header) => {
            const th = document.createElement("th");
            th.textContent = header.charAt(0).toUpperCase() + header.slice(1);
            tableHeader.appendChild(th);
          });

          data.forEach((corredor) => {
            const tr = document.createElement("tr");
            headers.forEach((header) => {
              const td = document.createElement("td");
              td.textContent = corredor[header];
              tr.appendChild(td);
            });
            tableBody.appendChild(tr);
          });
        } else {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = headers.length; // Ajusta esto según el número de columnas que tengas
          td.textContent = "No hay datos disponibles";
          tr.appendChild(td);
          tableBody.appendChild(tr);
        }
      }

      // Cargar las categorías cuando la página se carga
      window.onload = obtenerCategorias;

      // Enviar el formulario para filtrar corredores
      document
        .getElementById("rankingForm")
        .addEventListener("submit", enviarFormulario);
    </script>
  </body>
</html>
